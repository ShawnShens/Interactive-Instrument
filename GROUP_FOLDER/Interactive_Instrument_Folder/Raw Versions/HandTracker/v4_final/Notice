This is modularised version 4 built for state controller
